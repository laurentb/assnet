#!/usr/bin/env python
# -*- coding: utf-8 -*-
# vim: ft=python et softtabstop=4 cinoptions=4 shiftwidth=4 ts=4 ai

import os
from webob import Request
from webob.exc import HTTPMovedPermanently, HTTPNotFound
from paste.fileapp import FileApp

def app(environ, start_response):
    base = "/tmp/ass2m"
    req = Request(environ)
    parsed_path = req.path_info[1:]
    fpath = os.path.join(base, parsed_path)
    if os.path.isfile(fpath):
        fapp = FileApp(fpath)
        # serve the file, delegate everything to to FileApp
        return fapp(environ, start_response)

    if os.path.isdir(fpath):
        if parsed_path[-1:] != "/":
            resp = HTTPMovedPermanently(location=req.path_info+"/")
            return resp(environ, start_response)
        else:
            return listdir(base, parsed_path, start_response)

    resp = HTTPNotFound()
    return resp(environ, start_response)


def listdir(base, relpath, start_response):
    directory = os.path.join(base, relpath)
    start_response('200 OK', [('content-type', 'text/html')])
    yield """
<html>
<head>
    <title>ass2m</title>
</head>
<body>
<h1>Listing ./%s</h1>
<ul>""" % relpath
    for filename in os.listdir(directory):
        if os.path.isdir(os.path.join(directory, filename)):
            yield '<li><strong><a href="%s/">%s</a></strong></li>' % (filename, filename)
        else:
            yield '<li><a href="%s">%s</a></li>' % (filename, filename)
    yield """
</ul>
</body>
</html>"""

if __name__ == '__main__':
    from paste import httpserver
    httpserver.serve(app, host='0.0.0.0', port='8042')
